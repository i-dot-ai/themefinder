name: LLM Evaluation

on:
  schedule:
    - cron: '0 3 * * *'  # 3am UTC daily
  pull_request:
    paths:
      - 'evals/**'
      - 'src/themefinder/**'
      - '.github/workflows/eval.yml'
  workflow_dispatch:
    inputs:
      eval_type:
        description: 'Which eval to run'
        type: choice
        options:
          - generation
          - all
        default: 'generation'

jobs:
  start-runner:
    uses: i-dot-ai/i-dot-ai-core-github-actions/.github/workflows/start-runner.yml@main
    permissions: write-all
    with:
      EC2_INSTANCE_TYPE: t3.medium
      ENVIRONMENT: prod
    secrets:
      AWS_GITHUBRUNNER_USER_ACCESS_KEY: ${{ secrets.AWS_GITHUBRUNNER_USER_ACCESS_KEY }}
      AWS_GITHUBRUNNER_USER_SECRET_ID: ${{ secrets.AWS_GITHUBRUNNER_USER_SECRET_ID }}
      AWS_GITHUBRUNNER_PAT: ${{ secrets.AWS_GITHUBRUNNER_PAT }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}

  eval:
    needs: start-runner
    runs-on: ${{ needs.start-runner.outputs.label }}
    environment: eval

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: '.python-version'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: |
          uv venv
          uv pip sync requirements-dev.txt
          uv pip install -e .

      - name: Get version info
        id: version
        run: |
          VERSION=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "short_sha=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Run generation eval
        id: eval
        env:
          AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
          AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
          OPENAI_API_VERSION: ${{ secrets.AZURE_OPENAI_API_VERSION }}
          DEPLOYMENT_NAME: ${{ secrets.DEPLOYMENT_NAME }}
          LANGFUSE_SECRET_KEY: ${{ secrets.LANGFUSE_SECRET_KEY }}
          LANGFUSE_PUBLIC_KEY: ${{ secrets.LANGFUSE_PUBLIC_KEY }}
          LANGFUSE_BASE_URL: ${{ secrets.LANGFUSE_BASE_URL }}
        run: |
          cd evals
          uv run python eval_generation.py 2>&1 | tee results.txt

          # Extract key metrics for Slack
          if grep -q "Precision Average Groundedness" results.txt; then
            echo "eval_success=true" >> $GITHUB_OUTPUT
            PRECISION=$(grep -oP "Precision Average Groundedness.*?np.float64\(\K[0-9.]+" results.txt | tail -1)
            RECALL=$(grep -oP "Recall Average topic Representation.*?np.float64\(\K[0-9.]+" results.txt | tail -1)
            echo "precision=$PRECISION" >> $GITHUB_OUTPUT
            echo "recall=$RECALL" >> $GITHUB_OUTPUT
          else
            echo "eval_success=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: eval-results-${{ github.run_id }}
          path: evals/results.txt
          retention-days: 90

      - name: Notify Slack on success
        if: steps.eval.outputs.eval_success == 'true'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "✅ ThemeFinder Eval Complete",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "✅ *ThemeFinder Nightly Eval*\n`v${{ steps.version.outputs.version }}` · `${{ steps.version.outputs.short_sha }}`\n• Precision: ${{ steps.eval.outputs.precision }}/5\n• Recall: ${{ steps.eval.outputs.recall }}/5\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"
                  }
                }
              ]
            }

      - name: Notify Slack on failure
        if: failure() || steps.eval.outputs.eval_success == 'false'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "⚠️ ThemeFinder Eval Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "⚠️ *ThemeFinder Eval Failed*\n`v${{ steps.version.outputs.version }}` · `${{ steps.version.outputs.short_sha }}`\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"
                  }
                }
              ]
            }

  stop-runner:
    needs: [start-runner, eval]
    uses: i-dot-ai/i-dot-ai-core-github-actions/.github/workflows/stop-runner.yml@main
    if: needs.start-runner.outputs.use-persisted == 0 && always()
    permissions: write-all
    with:
      RUNNER_LABEL: ${{ needs.start-runner.outputs.label }}
      EC2_INSTANCE_ID: ${{ needs.start-runner.outputs.ec2-instance-id }}
    secrets:
      AWS_GITHUBRUNNER_USER_ACCESS_KEY: ${{ secrets.AWS_GITHUBRUNNER_USER_ACCESS_KEY }}
      AWS_GITHUBRUNNER_USER_SECRET_ID: ${{ secrets.AWS_GITHUBRUNNER_USER_SECRET_ID }}
      AWS_GITHUBRUNNER_PAT: ${{ secrets.AWS_GITHUBRUNNER_PAT }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
